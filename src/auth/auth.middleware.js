import jwt from 'jsonwebtoken';

// JWT secret key - In production, use environment variable
const JWT_SECRET = process.env.JWT_SECRET || 'demo-secret-key-change-in-production';

/**
 * Valid roles for client authentication
 */
export const ROLES = {
  KIOSK: 'KIOSK',
  MONITOR: 'MONITOR'
};

/**
 * Middleware to authenticate Socket.IO connections using JWT
 * 
 * This middleware validates JWT tokens and attaches role and clientId
 * to the socket context. Connections without valid tokens are rejected.
 * 
 * Architecture Note: This backend is view-only and does NOT process
 * video streams. It only handles signaling and event broadcasting.
 * 
 * @param {Object} socket - Socket.IO socket instance
 * @param {Function} next - Next middleware function
 */
export const authenticateSocket = (socket, next) => {
  try {
    // Extract token from handshake auth
    const token = socket.handshake.auth?.token || socket.handshake.headers?.authorization?.replace('Bearer ', '');

    if (!token) {
      return next(new Error('Authentication error: No token provided'));
    }

    // Verify JWT token
    const decoded = jwt.verify(token, JWT_SECRET);

    // Validate role
    if (!decoded.role || (decoded.role !== ROLES.KIOSK && decoded.role !== ROLES.MONITOR)) {
      return next(new Error('Authentication error: Invalid role'));
    }

    // Validate clientId
    if (!decoded.clientId) {
      return next(new Error('Authentication error: Missing clientId'));
    }

    // Attach authentication data to socket context
    socket.data.role = decoded.role;
    socket.data.clientId = decoded.clientId;
    socket.data.userId = decoded.userId || decoded.clientId;

    next();
  } catch (error) {
    if (error.name === 'JsonWebTokenError') {
      return next(new Error('Authentication error: Invalid token'));
    }
    if (error.name === 'TokenExpiredError') {
      return next(new Error('Authentication error: Token expired'));
    }
    return next(new Error('Authentication error: ' + error.message));
  }
};

/**
 * Helper function to generate JWT token for testing/demo purposes
 * In production, tokens should be generated by a separate auth service
 * 
 * @param {string} clientId - Unique client identifier
 * @param {string} role - Client role (KIOSK or MONITOR)
 * @param {number} expiresIn - Token expiration time in seconds (default: 24 hours)
 * @returns {string} JWT token
 */
export const generateToken = (clientId, role, expiresIn = 86400) => {
  if (!clientId || !role) {
    throw new Error('clientId and role are required');
  }

  if (role !== ROLES.KIOSK && role !== ROLES.MONITOR) {
    throw new Error('Invalid role. Must be KIOSK or MONITOR');
  }

  return jwt.sign(
    {
      clientId,
      role,
      iat: Math.floor(Date.now() / 1000)
    },
    JWT_SECRET,
    { expiresIn }
  );
};
